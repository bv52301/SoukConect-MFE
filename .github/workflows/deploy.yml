name: Deploy to Server

on:
  push:
    branches: [main, production]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------
      # 1. Checkout
      # -----------------------------
      - name: Checkout repository
        uses: actions/checkout@v3

      # -----------------------------
      # 2. Node + pnpm (CI build only)
      # -----------------------------
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10

      # -----------------------------
      # 3. Install & Build
      # -----------------------------
      - name: Install dependencies
        run: pnpm install

      - name: Build all apps
        env:
          NEXT_PUBLIC_API_URL: "http://ec2-52-76-119-114.ap-southeast-1.compute.amazonaws.com/api"
        run: pnpm run build

      - name: Ensure public directories exist
        run: |
          mkdir -p apps/shell/public
          mkdir -p apps/food-connect/public

      - name: Verify build output
        run: |
          echo "=== shell .next ==="
          ls -la apps/shell/.next
          echo "=== shell public ==="
          ls -la apps/shell/public || echo "(empty or missing)"
          echo "=== food-connect .next ==="
          ls -la apps/food-connect/.next
          echo "=== food-connect public ==="
          ls -la apps/food-connect/public || echo "(empty or missing)"

      # -----------------------------
      # 4. FORCE RESET SERVER DIR
      # -----------------------------
      - name: Prepare server directory
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ec2-user
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            sudo su - <<'EOF'
            set -e

            echo "==> Removing old deploy directory"
            rm -rf /var/www/soukconect

            echo "==> Recreating deploy directory"
            mkdir -p /var/www/soukconect

            echo "==> Giving ownership to ec2-user for SCP"
            chown -R ec2-user:ec2-user /var/www/soukconect
            EOF

      # -----------------------------
      # 5. COPY BUILD ARTIFACTS (SCP)
      # -----------------------------
      - name: Copy build to server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ec2-user
          key: ${{ secrets.SERVER_SSH_KEY }}
          target: /var/www/soukconect
          source: "apps/shell/.next/,apps/shell/public/,apps/shell/package.json,apps/shell/next.config.ts,apps/food-connect/.next/,apps/food-connect/public/,apps/food-connect/package.json,apps/food-connect/next.config.ts,packages/,package.json,pnpm-lock.yaml,pnpm-workspace.yaml,ecosystem.config.js"
          strip_components: 0

      # -----------------------------
      # 6. INSTALL + PM2 + SYSTEMD
      # -----------------------------
      - name: Deploy & restart via systemd
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ec2-user
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            sudo su - <<'EOF'
            set -e

            echo "==> Switching ownership to soukui"
            chown -R soukui:soukui /var/www/soukconect

            echo "==> Install production dependencies"
            cd /var/www/soukconect
            rm -rf node_modules
            sudo -u soukui pnpm install --prod --frozen-lockfile

            echo "==> Update PM2 process list"
            sudo -u soukui /home/soukui/.nvm/versions/node/v18.20.8/bin/pm2 delete souk-ui || true
            sudo -u soukui /home/soukui/.nvm/versions/node/v18.20.8/bin/pm2 delete souk-food-connect || true
            sudo -u soukui /home/soukui/.nvm/versions/node/v18.20.8/bin/pm2 start /var/www/soukconect/ecosystem.config.js
            sudo -u soukui /home/soukui/.nvm/versions/node/v18.20.8/bin/pm2 save

            echo "==> Restarting PM2 via systemd"
            systemctl restart pm2-soukui

            echo "==> Systemd service status"
            systemctl status pm2-soukui
            EOF

      # -----------------------------
      # 7. Health Check
      # -----------------------------
      - name: Health check
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ec2-user
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            sudo su - <<'EOF'
            SHELL_OK=false
            FOOD_OK=false

            echo "==> Checking shell app (port 3000)..."
            for i in {1..10}; do
              if curl -sf http://localhost:3000 >/dev/null; then
                echo "✅ Shell app is healthy"
                SHELL_OK=true
                break
              fi
              sleep 2
            done

            echo "==> Checking food-connect app (port 3001)..."
            for i in {1..10}; do
              if curl -sf http://localhost:3001 >/dev/null; then
                echo "✅ Food-connect app is healthy"
                FOOD_OK=true
                break
              fi
              sleep 2
            done

            echo "==> Systemd service status"
            systemctl is-active pm2-soukui

            echo "==> PM2 process list"
            sudo -u soukui /home/soukui/.nvm/versions/node/v18.20.8/bin/pm2 status

            if [ "$SHELL_OK" = true ] && [ "$FOOD_OK" = true ]; then
              echo "✅ All apps are healthy"
              exit 0
            fi

            echo "❌ Health check failed"
            if [ "$SHELL_OK" = false ]; then
              echo "Shell app logs:"
              sudo -u soukui /home/soukui/.nvm/versions/node/v18.20.8/bin/pm2 logs souk-ui --lines 30 --nostream
            fi
            if [ "$FOOD_OK" = false ]; then
              echo "Food-connect app logs:"
              sudo -u soukui /home/soukui/.nvm/versions/node/v18.20.8/bin/pm2 logs souk-food-connect --lines 30 --nostream
            fi
            exit 1
            EOF
