name: Deploy to Server

on:
  push:
    branches: [main, production]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------
      # 1. Checkout
      # -----------------------------
      - name: Checkout repository
        uses: actions/checkout@v3

      # -----------------------------
      # 2. Node + pnpm (CI build only)
      # -----------------------------
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10

      # -----------------------------
      # 3. Install & Build
      # -----------------------------
      - name: Install dependencies
        run: pnpm install

      - name: Build shell app
        run: pnpm --filter @soukconect/shell build

      - name: Verify build output
        run: |
          echo "=== .next ==="
          ls -la apps/shell/.next
          echo "=== public ==="
          ls -la apps/shell/public

      # -----------------------------
      # 4. FORCE RESET SERVER DIR (ROOT)
      # -----------------------------
      - name: Prepare server directory
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ec2-user
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            sudo su - <<'EOF'
            set -e

            echo "==> Removing old deploy directory"
            rm -rf /var/www/soukconect

            echo "==> Recreating deploy directory"
            mkdir -p /var/www/soukconect

            echo "==> Giving ownership to ec2-user for SCP"
            chown -R ec2-user:ec2-user /var/www/soukconect
            EOF

      # -----------------------------
      # 5. COPY BUILD ARTIFACTS (SCP)
      # -----------------------------
      - name: Copy build to server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ec2-user
          key: ${{ secrets.SERVER_SSH_KEY }}
          target: /var/www/soukconect
          source: "apps/shell/.next/,apps/shell/public/,apps/shell/package.json,packages/,package.json,pnpm-lock.yaml,pnpm-workspace.yaml,ecosystem.config.js"
          strip_components: 0

      # -----------------------------
      # 6. ROOT INSTALL + PM2 START
      # -----------------------------
      - name: Root deploy & PM2 start
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ec2-user
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            sudo su - <<'EOF'
            set -e

            echo "==> Switching ownership back to root"
            chown -R root:root /var/www/soukconect

            echo "==> Cleaning old PM2 state"
            pm2 delete souk-ui || true

            echo "==> Install production dependencies at root"
            cd /var/www/soukconect
            rm -rf node_modules
            pnpm install --prod --frozen-lockfile

            echo "==> Create next.config.js (skip TypeScript requirement)"
            cat > /var/www/soukconect/apps/shell/next.config.js << 'NEXTCONFIG'
            /** @type {import('next').NextConfig} */
            const nextConfig = {
              reactStrictMode: true,
              transpilePackages: [],
            };

            module.exports = nextConfig;
            NEXTCONFIG

            echo "==> Start application with PM2 (root)"
            cd /var/www/soukconect
            pm2 start ecosystem.config.js
            pm2 save
            pm2 startup systemd -u root --hp /root
            EOF

      # -----------------------------
      # 7. Health Check
      # -----------------------------
      - name: Health check
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ec2-user
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            sudo su - <<'EOF'
            for i in {1..10}; do
              if curl -sf http://localhost:3000 >/dev/null; then
                echo "✅ UI is healthy"
                pm2 status
                exit 0
              fi
              sleep 2
            done

            echo "❌ UI failed health check"
            pm2 logs souk-ui --lines 50
            exit 1
            EOF
