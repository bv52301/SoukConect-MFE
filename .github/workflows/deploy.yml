name: Deploy to Server

on:
  push:
    branches: [main, production]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------
      # 1. Checkout
      # -----------------------------
      - name: Checkout repository
        uses: actions/checkout@v3

      # -----------------------------
      # 2. Node + pnpm (CI build only)
      # -----------------------------
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10

      # -----------------------------
      # 3. Install & Build
      # -----------------------------
      - name: Install dependencies
        run: pnpm install

      - name: Build all apps
        env:
          NEXT_PUBLIC_API_URL: "http://52.76.119.114/api"
        run: pnpm run build

      - name: Ensure public directories exist
        run: |
          mkdir -p apps/shell/public
          mkdir -p apps/food-connect/public

      # -----------------------------
      # 4. FORCE RESET SERVER DIR (Prevents stale .ts files)
      # -----------------------------
      - name: Prepare server directory
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ec2-user
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            sudo su - <<'EOF'
            set -e
            echo "==> Cleaning old deployment to prevent stale config files"
            rm -rf /var/www/soukconect
            mkdir -p /var/www/soukconect
            chown -R ec2-user:ec2-user /var/www/soukconect
            EOF

      # -----------------------------
      # 5. COPY BUILD ARTIFACTS (SCP)
      # -----------------------------
      - name: Copy build to server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ec2-user
          key: ${{ secrets.SERVER_SSH_KEY }}
          target: /var/www/soukconect
          source: "apps/shell/.next/,apps/shell/public/,apps/shell/package.json,apps/shell/next.config.js,apps/food-connect/.next/,apps/food-connect/public/,apps/food-connect/package.json,apps/food-connect/next.config.js,packages/,package.json,pnpm-lock.yaml,pnpm-workspace.yaml,ecosystem.config.js"
          strip_components: 0

      # -----------------------------
      # 6. INSTALL + PM2 + SYSTEMD
      # -----------------------------
      - name: Deploy & restart via systemd
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ec2-user
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            sudo su - <<'EOF'
            set -e

            NVM_DIR="/home/soukui/.nvm"
            NODE_BIN="/home/soukui/.nvm/versions/node/v18.20.8/bin"
            PM2="$NODE_BIN/pm2"
            PNPM="$NODE_BIN/pnpm"

            echo "==> Switching ownership to soukui"
            chown -R soukui:soukui /var/www/soukconect

            echo "==> Install production dependencies"
            cd /var/www/soukconect
            # Removing node_modules ensures pnpm doesn't have a partial-install conflict
            rm -rf node_modules
            sudo -u soukui bash -c "source $NVM_DIR/nvm.sh && $PNPM install --prod --frozen-lockfile"

            echo "==> Update PM2 process list"
            sudo -u soukui bash -c "source $NVM_DIR/nvm.sh && $PM2 delete all || true"
            sudo -u soukui bash -c "source $NVM_DIR/nvm.sh && $PM2 start /var/www/soukconect/ecosystem.config.js"
            sudo -u soukui bash -c "source $NVM_DIR/nvm.sh && $PM2 save"

            echo "==> Restarting PM2 via systemd"
            systemctl restart pm2-soukui
            systemctl status pm2-soukui --no-pager
            EOF

      # -----------------------------
      # 7. Health Check
      # -----------------------------
      - name: Health check
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ec2-user
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            sudo su - <<'EOF'
            NVM_DIR="/home/soukui/.nvm"
            NODE_BIN="/home/soukui/.nvm/versions/node/v18.20.8/bin"
            PM2="$NODE_BIN/pm2"

            SHELL_OK=false
            FOOD_OK=false

            echo "==> Checking shell app (port 3000)..."
            for i in {1..15}; do
              if curl -sf http://localhost:3000 >/dev/null; then
                echo "✅ Shell app is healthy"
                SHELL_OK=true
                break
              fi
              sleep 2
            done

            echo "==> Checking food-connect app (port 3001)..."
            for i in {1..15}; do
              if curl -sf http://localhost:3001 >/dev/null; then
                echo "✅ Food-connect app is healthy"
                FOOD_OK=true
                break
              fi
              sleep 2
            done

            if [ "$SHELL_OK" = true ] && [ "$FOOD_OK" = true ]; then
              echo "✅ All apps are healthy"
              exit 0
            else
              echo "❌ Health check failed"
              sudo -u soukui bash -c "source $NVM_DIR/nvm.sh && $PM2 status"
              exit 1
            fi
            EOF
